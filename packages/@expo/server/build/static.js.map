{"version":3,"file":"static.js","names":["debug","require","getStaticMiddleware","root","opts","extensions","req","res","next","url","method","pathname","URL","stream","send","forwardError","on","onFile","error","err","statusCode","pipe"],"sources":["../src/static.ts"],"sourcesContent":["import send from 'send';\nimport { URL } from 'url';\n\nimport { ServerRequest, ServerResponse } from './server.types';\n\nconst debug = require('debug')('expo:server:static') as typeof console.log;\n\nexport function getStaticMiddleware(root: string) {\n  debug(`hosting:`, root);\n  const opts = {\n    root,\n    extensions: ['html'],\n  };\n  return (req: ServerRequest, res: ServerResponse, next: any) => {\n    if (!req?.url || (req.method !== 'GET' && req.method !== 'HEAD')) {\n      return next();\n    }\n\n    // const platform = parsePlatformHeader(req);\n    // Currently this is web-only\n    // if (platform && platform !== 'web') {\n    //   return next();\n    // }\n\n    const pathname = new URL(req.url, 'https://acme.dev').pathname;\n    if (!pathname) {\n      return next();\n    }\n\n    debug(`stream:`, pathname);\n    const stream = send(req, pathname, opts);\n\n    // add file listener for fallthrough\n    let forwardError = false;\n    stream.on('file', function onFile() {\n      // once file is determined, always forward error\n      forwardError = true;\n    });\n\n    // forward errors\n    stream.on('error', function error(err: any) {\n      if (forwardError || !(err.statusCode < 500)) {\n        next(err);\n        return;\n      }\n\n      next();\n    });\n\n    // pipe\n    stream.pipe(res);\n  };\n}\n"],"mappings":";;;;;;AAAA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AAA0B;AAI1B,MAAMA,KAAK,GAAGC,OAAO,CAAC,OAAO,CAAC,CAAC,oBAAoB,CAAuB;AAEnE,SAASC,mBAAmB,CAACC,IAAY,EAAE;EAChDH,KAAK,CAAE,UAAS,EAAEG,IAAI,CAAC;EACvB,MAAMC,IAAI,GAAG;IACXD,IAAI;IACJE,UAAU,EAAE,CAAC,MAAM;EACrB,CAAC;EACD,OAAO,CAACC,GAAkB,EAAEC,GAAmB,EAAEC,IAAS,KAAK;IAC7D,IAAI,EAACF,GAAG,aAAHA,GAAG,eAAHA,GAAG,CAAEG,GAAG,KAAKH,GAAG,CAACI,MAAM,KAAK,KAAK,IAAIJ,GAAG,CAACI,MAAM,KAAK,MAAO,EAAE;MAChE,OAAOF,IAAI,EAAE;IACf;;IAEA;IACA;IACA;IACA;IACA;;IAEA,MAAMG,QAAQ,GAAG,KAAIC,UAAG,EAACN,GAAG,CAACG,GAAG,EAAE,kBAAkB,CAAC,CAACE,QAAQ;IAC9D,IAAI,CAACA,QAAQ,EAAE;MACb,OAAOH,IAAI,EAAE;IACf;IAEAR,KAAK,CAAE,SAAQ,EAAEW,QAAQ,CAAC;IAC1B,MAAME,MAAM,GAAG,IAAAC,eAAI,EAACR,GAAG,EAAEK,QAAQ,EAAEP,IAAI,CAAC;;IAExC;IACA,IAAIW,YAAY,GAAG,KAAK;IACxBF,MAAM,CAACG,EAAE,CAAC,MAAM,EAAE,SAASC,MAAM,GAAG;MAClC;MACAF,YAAY,GAAG,IAAI;IACrB,CAAC,CAAC;;IAEF;IACAF,MAAM,CAACG,EAAE,CAAC,OAAO,EAAE,SAASE,KAAK,CAACC,GAAQ,EAAE;MAC1C,IAAIJ,YAAY,IAAI,EAAEI,GAAG,CAACC,UAAU,GAAG,GAAG,CAAC,EAAE;QAC3CZ,IAAI,CAACW,GAAG,CAAC;QACT;MACF;MAEAX,IAAI,EAAE;IACR,CAAC,CAAC;;IAEF;IACAK,MAAM,CAACQ,IAAI,CAACd,GAAG,CAAC;EAClB,CAAC;AACH"}