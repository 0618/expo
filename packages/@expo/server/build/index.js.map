{"version":3,"file":"index.js","names":["installGlobals","handleRouteHandlerAsync","func","req","res","next","response","headers","key","value","Object","entries","setHeader","status","statusCode","body","end","error","console","createRequestHandler","distFolder","statics","path","join","routesManifest","JSON","parse","fs","readFileSync","map","regex","RegExp","serveStatic","getStaticMiddleware","handler","request","err","url","method","URL","sanitizedPathname","pathname","replace","Promise","rej","route","test","src","startsWith","require"],"sources":["../src/index.ts"],"sourcesContent":["import fs from 'fs';\nimport path from 'path';\nimport { URL } from 'url';\n\nimport { ExpoResponse, installGlobals } from './environment';\nimport { ServerNext, ServerRequest, ServerResponse } from './server.types';\nimport { getStaticMiddleware } from './static';\n\n// Given build dir\n// parse path\n// import middleware function\n\ninstallGlobals();\n\nasync function handleRouteHandlerAsync(\n  func: any,\n  req: ServerRequest,\n  res: ServerResponse,\n  next: ServerNext\n) {\n  try {\n    // 4. Execute.\n    const response = (await func?.(req, res, next)) as ExpoResponse | undefined;\n\n    // 5. Respond\n    if (response) {\n      if (response.headers) {\n        for (const [key, value] of Object.entries(response.headers)) {\n          res.setHeader(key, value);\n        }\n      }\n\n      if (response.status) {\n        res.statusCode = response.status;\n      }\n\n      if (response.body) {\n        res.end(response.body);\n      } else {\n        res.end();\n      }\n    } else {\n      // TODO: Not sure what to do here yet\n      res.statusCode = 404;\n      res.end();\n    }\n  } catch (error) {\n    // TODO: Symbolicate error stack\n    console.error(error);\n    res.statusCode = 500;\n    res.end();\n  }\n}\n\n// TODO: Reuse this for dev as well\nexport function createRequestHandler(distFolder: string) {\n  const statics = path.join(distFolder, 'static');\n\n  const routesManifest = JSON.parse(\n    fs.readFileSync(path.join(distFolder, 'routes-manifest.json'), 'utf-8')\n  ).map((value: any) => {\n    return {\n      ...value,\n      regex: new RegExp(value.regex),\n    };\n  });\n\n  const serveStatic = getStaticMiddleware(statics);\n\n  return async function handler(\n    request: ServerRequest,\n    response: ServerResponse,\n    // TODO\n    next: ServerNext = function (err) {\n      console.error(err);\n      response.statusCode = 404;\n\n      return response.end('Not found');\n    }\n  ) {\n    if (!request.url || !request.method) {\n      return next();\n    }\n\n    const url = new URL(request.url, 'http://acme.dev');\n\n    const sanitizedPathname = url.pathname.replace(/^\\/+/, '').replace(/\\/+$/, '') + '/';\n\n    await new Promise<void>((res, rej) =>\n      serveStatic(request, response, (err: any) => (err ? rej(err) : res()))\n    );\n\n    for (const route of routesManifest) {\n      if (route.regex.test(sanitizedPathname)) {\n        // console.log('Using:', route.src, sanitizedPathname, route.regex);\n        if (route.src.startsWith('./static/')) {\n          return serveStatic(request, response, next);\n        }\n        const func = require(path.join(distFolder, route.src));\n\n        if (func[request.method]) {\n          return handleRouteHandlerAsync(func[request.method], request, response, next);\n        } else {\n          response.statusCode = 405;\n          return response.end('Method not allowed');\n        }\n      }\n    }\n\n    // 404\n    response.statusCode = 404;\n    return response.end('Not found');\n  };\n}\n"],"mappings":"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"}